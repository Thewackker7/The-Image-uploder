{% extends 'base.html' %}

{% block content %}
<div class="max-w-4xl mx-auto space-y-12">

    <!-- Upload Section -->
    <div class="glass-panel p-6">
        <h2 class="text-xl font-bold mb-4 text-gray-200">Upload Memories</h2>
        <div class="flex flex-col md:flex-row gap-6 items-start">

            <div class="flex-1 w-full bg-blue-900/10 p-5 rounded-xl border border-blue-500/20 shadow-inner">
                <h3 class="text-xs font-bold text-blue-400 mb-4 uppercase tracking-widest flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                        </path>
                    </svg>
                    Device Upload
                </h3>
                <form method="post" enctype="multipart/form-data" class="space-y-4">
                    {% csrf_token %}
                    <div class="relative group">
                        <input type="file" name="image_file" id="id_image_file" class="hidden" accept="image/*"
                            onchange="updateFileName(this)" required>
                        <label for="id_image_file"
                            class="flex flex-col items-center justify-center w-full px-4 py-8 border-2 border-dashed border-blue-500/30 rounded-lg cursor-pointer bg-blue-500/5 hover:bg-blue-500/10 hover:border-blue-500/50 transition-all">
                            <svg class="w-10 h-10 text-blue-400 mb-3 group-hover:scale-110 transition-transform"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                                </path>
                            </svg>
                            <span id="file-name" class="text-sm text-blue-300 font-bold text-center">Pick a memory from
                                PC</span>
                        </label>
                    </div>
                    <button type="submit"
                        class="w-full py-3.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white rounded-xl font-black text-sm uppercase tracking-widest transition-all shadow-[0_0_20px_rgba(37,99,235,0.3)] flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Push to Gallery
                    </button>
                </form>
            </div>

            <div class="hidden md:block w-px bg-gray-700/50 self-stretch"></div>

            <!-- Drive Upload -->
            <div class="flex-1 w-full bg-green-900/10 p-5 rounded-xl border border-green-500/20 shadow-inner">
                <h3 class="text-xs font-bold text-green-400 mb-4 uppercase tracking-widest flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A10.003 10.003 0 0012 3v8h8a10.003 10.003 0 00-10 10c-.07 0-.139-.001-.208-.003L12 11z">
                        </path>
                    </svg>
                    Cloud Import
                </h3>
                <div class="flex flex-col items-center justify-center py-6">
                    <svg class="w-12 h-12 mb-4" viewBox="0 0 87.3 78" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="m6.6 66.85 3.85 6.65c.8 1.4 1.9 2.5 3.2 3.3l12.3-21.3-8.7-15-10.65 18.35c-.6 1.1-.65 2.4-.6 3.65.05 1.25.6 2.4 1.2 3.35z"
                            fill="#0066da" />
                        <path
                            d="m43.65 25-12.3-21.35c-.7-1.25-1.75-2.25-3-2.85-1.25-.6-2.6-.65-3.85-.15l-6.65 3.85-12.35 21.4 12.3 21.3 13.55-23.55c1.1-1.9 3.25-3.05 5.5-3.05h17.9l-11.1-15.6z"
                            fill="#00ac47" />
                        <path
                            d="m73.55 76.8c1.25.6 2.6.65 3.85.15 1.25-.5 2.3-1.5 3-2.75l3.85-6.65c.6-1.1.65-2.4.6-3.65-.05-1.25-.6-2.4-1.2-3.35l-11.1-19.15h-24.7l12.35 21.35 13.35 14.05z"
                            fill="#ea4335" />
                        <path
                            d="m43.65 25 11.05-19.1h26c2.2 0 4.2 1.15 5.3 3.05l-12.3 21.3h-17.95c-2.25.05-4.4 1.25-5.5 3.15z"
                            fill="#ffba00" />
                    </svg>
                    <p class="text-[10px] text-gray-500 font-black uppercase tracking-widest text-center mb-6">Sync your
                        Google Drive photos</p>
                    <button id="authorize_button"
                        class="w-full py-3.5 bg-white hover:bg-gray-100 text-gray-900 rounded-xl font-black text-sm uppercase tracking-widest transition-all shadow-xl flex items-center justify-center gap-3 border border-gray-300">
                        Connect Drive
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Gallery Slider -->
    {% if posts %}
    <div class="space-y-4">
        <div class="flex justify-between items-center px-2">
            <h2 class="text-xl font-bold text-gray-200 flex items-center gap-3">
                <span
                    class="w-3 h-3 rounded-full bg-cyan-500 shadow-[0_0_10px_rgba(6,182,212,0.5)] animate-pulse"></span>
                Shared Gallery
            </h2>
            <div id="gallery-counter"
                class="px-3 py-1 bg-black/50 backdrop-blur-md rounded-full border border-white/10 text-[10px] font-black uppercase tracking-widest text-cyan-400">
                1 / {{ posts|length }}
            </div>
        </div>
        <!-- Slider main container -->
        <div class="swiper">
            <!-- Additional required wrapper -->
            <div class="swiper-wrapper">
                {% for post in posts %}
                {% if post.image_file or post.image_url %}
                <div class="swiper-slide relative group card-item" data-id="{{ post.id }}"
                    data-owner="{{ post.guest_name }}">
                    {% if post.image_file %}
                    <img src="{{ post.image_file.url }}" alt="Uploaded by {{ post.guest_name }}"
                        class="gallery-img cursor-pointer" title="Double click to delete your photo">
                    {% elif post.image_url %}
                    <img src="{{ post.image_url }}" alt="Shared by {{ post.guest_name }}"
                        class="gallery-img cursor-pointer" title="Double click to delete your photo">
                    {% endif %}

                    <div
                        class="absolute bottom-0 left-0 right-0 bg-black/80 backdrop-blur-md p-4 translate-y-full group-hover:translate-y-0 transition-all duration-300 border-t border-white/10">
                        <p class="text-cyan-400 text-xs font-black uppercase tracking-tighter">{{ post.guest_name }}</p>
                        <p class="text-gray-500 text-[9px] uppercase font-bold mt-0.5">{{ post.created_at|date:"F d, Y
                            H:i" }}</p>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            <!-- If we need pagination -->
            <div class="swiper-pagination"></div>
            <!-- If we need navigation buttons -->
            <div class="swiper-button-prev !text-cyan-500"></div>
            <div class="swiper-button-next !text-cyan-500"></div>
        </div>
    </div>
    {% endif %}

    <!-- Single Post Modal -->
    <div id="post-modal"
        class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl transition-all duration-300 opacity-0">
        <div
            class="relative max-w-5xl w-full max-h-[90vh] glass-panel overflow-hidden border-white/20 flex flex-col md:flex-row shadow-2xl">
            <!-- Close Button -->
            <button onclick="closeModal()"
                class="absolute top-4 right-4 z-10 p-2 bg-black/50 hover:bg-black/70 text-white rounded-full transition-all border border-white/10">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <!-- Image Section -->
            <div class="flex-grow bg-black flex items-center justify-center min-h-[300px]">
                <img id="modal-img" src="" alt="" class="max-w-full max-h-[80vh] object-contain">
            </div>

            <!-- Info Section -->
            <div class="w-full md:w-80 p-8 flex flex-col justify-between bg-zinc-900/80 border-l border-white/10">
                <div class="space-y-6">
                    <div>
                        <p class="text-[10px] font-black uppercase tracking-widest text-cyan-500 mb-2">Captured By</p>
                        <p id="modal-owner" class="text-2xl font-bold text-gray-100 tracking-tight"></p>
                    </div>
                    <div>
                        <p class="text-[10px] font-black uppercase tracking-widest text-gray-500 mb-2">Shared On</p>
                        <p id="modal-date" class="text-sm font-medium text-gray-400"></p>
                    </div>
                </div>

                <div id="modal-actions" class="mt-12 pt-8 border-t border-white/10 hidden">
                    <button id="modal-delete-btn"
                        class="w-full py-4 bg-red-600/10 hover:bg-red-600/20 text-red-500 border border-red-500/30 rounded-2xl font-black text-xs uppercase tracking-widest transition-all flex items-center justify-center gap-3">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                            </path>
                        </svg>
                        Delete Memory
                    </button>
                    <p class="text-[9px] text-gray-600 font-bold uppercase tracking-widest text-center mt-3">This action
                        cannot be undone</p>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script>
    function updateFileName(input) {
        const span = document.getElementById('file-name');
        if (input.files && input.files.length > 0) {
            span.textContent = input.files[0].name;
            span.classList.remove('text-blue-300');
            span.classList.add('text-green-400');
        } else {
            span.textContent = 'Pick a memory from PC';
            span.classList.add('text-blue-300');
            span.classList.remove('text-green-400');
        }
    }

    // Initialize Swiper
    {% if posts %}
    const swiper = new Swiper('.swiper', {
        loop: true,
        pagination: { el: '.swiper-pagination', clickable: true },
        navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
        effect: 'coverflow',
        coverflowEffect: {
            rotate: 10,
            stretch: 0,
            depth: 200,
            modifier: 1,
            slideShadows: true,
        },
        centeredSlides: true,
        slidesPerView: 'auto',
        on: {
            slideChange: function () {
                const total = this.slides.filter(s => !s.classList.contains('swiper-slide-duplicate')).length;
                const current = this.realIndex + 1;
                document.getElementById('gallery-counter').textContent = `${current} / ${total}`;
            }
        }
    });
    {% endif %}

    // Google Picker API Logic
    const DEVELOPER_KEY = '{{ google_api_key }}';
    const CLIENT_ID = '{{ google_client_id }}';
    const APP_ID = '{{ google_app_id }}';
    const SCOPE = ['https://www.googleapis.com/auth/drive.readonly'];

    let pickerApiLoaded = false;
    let gisInited = false;
    let tokenClient;
    let accessToken = null;

    function onApiLoad() {
        gapi.load('picker', { 'callback': () => { pickerApiLoaded = true; } });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPE.join(' '),
            callback: '', // defined later
        });
        gisInited = true;
    }

    function triggerAuth() {
        console.log("Triggering Google Auth...");
        tokenClient.callback = async (response) => {
            console.log("Auth response:", response);
            if (response.error !== undefined) {
                alert("Google Auth Error: " + response.error);
                console.error(response);
                return;
            }
            accessToken = response.access_token;
            console.log("Access token acquired, opening picker...");
            createPicker();
        };

        if (accessToken === null) {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        } else {
            tokenClient.requestAccessToken({ prompt: '' });
        }
    }

    function createPicker() {
        if (pickerApiLoaded && accessToken) {
            console.log("Creating Picker...");
            const view = new google.picker.DocsView(google.picker.ViewId.DOCS_IMAGES);
            view.setIncludeFolders(true);

            const picker = new google.picker.PickerBuilder()
                .addView(view)
                .setOAuthToken(accessToken)
                .setDeveloperKey(DEVELOPER_KEY)
                .setCallback(pickerCallback)
                .setOrigin(window.location.protocol + '//' + window.location.host)
                .build();
            picker.setVisible(true);
        } else {
            console.error("Picker not ready:", { pickerApiLoaded, accessToken });
            alert("Google Picker failed to initialize. Try refreshing.");
        }
    }

    function pickerCallback(data) {
        if (data[google.picker.Response.ACTION] == google.picker.Action.PICKED) {
            const doc = data[google.picker.Response.DOCUMENTS][0];
            const fileId = doc[google.picker.Document.ID];
            // Format a direct view URL for the image
            const url = `https://drive.google.com/uc?export=view&id=${fileId}`;
            console.log("Picked file ID:", fileId, "URL:", url);
            uploadToBackend(url);
        } else if (data[google.picker.Response.ACTION] == google.picker.Action.CANCEL) {
            console.log("Picker cancelled.");
        }
    }

    function uploadToBackend(url) {
        console.log("Uploading to backend:", url);
        fetch('/upload/drive/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        })
            .then(response => response.json())
            .then(data => {
                console.log("Backend response:", data);
                if (data.status === 'success') {
                    window.location.reload();
                } else {
                    alert('Cloud import failed: ' + data.message);
                }
            })
            .catch(err => {
                console.error("Fetch error:", err);
                alert("Network error while importing photo.");
            });
    }

    document.getElementById('authorize_button').addEventListener('click', function () {
        if (gisInited && pickerApiLoaded) {
            triggerAuth();
        } else {
            alert("Google API is still loading. Please wait a moment.");
        }
    });

    // Modal logic
    const modal = document.getElementById('post-modal');
    const modalImg = document.getElementById('modal-img');
    const modalOwner = document.getElementById('modal-owner');
    const modalDate = document.getElementById('modal-date');
    const modalActions = document.getElementById('modal-actions');
    const deleteBtn = document.getElementById('modal-delete-btn');
    let currentPostId = null;

    function openModal(imgSrc, owner, date, postId) {
        currentPostId = postId;
        modalImg.src = imgSrc;
        modalOwner.textContent = owner;
        modalDate.textContent = date;

        const currentGuest = '{{ guest_name }}';
        if (owner === currentGuest) {
            modalActions.classList.remove('hidden');
        } else {
            modalActions.classList.add('hidden');
        }

        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.classList.add('opacity-100');
        }, 10);
    }

    function closeModal() {
        modal.classList.remove('opacity-100');
        modal.classList.add('opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    // Double click to view/delete
    document.querySelectorAll('.gallery-img').forEach(img => {
        img.addEventListener('dblclick', function () {
            const card = this.closest('.card-item');
            const postId = card.dataset.id;
            const owner = card.dataset.owner;
            // Get date from the specific paragraph in the card
            const dateStr = card.querySelector('p.text-gray-500').textContent;
            const imgSrc = this.src;

            openModal(imgSrc, owner, dateStr, postId);
        });
    });

    deleteBtn.addEventListener('click', function () {
        if (currentPostId) {
            window.location.href = `/delete/${currentPostId}/`;
        }
    });

    // Close on click outside
    modal.addEventListener('click', function (e) {
        if (e.target === modal) closeModal();
    });

    // Close on Escape
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') closeModal();
    });

</script>
<script async defer src="https://apis.google.com/js/api.js" onload="onApiLoad()"></script>
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
{% endblock %}